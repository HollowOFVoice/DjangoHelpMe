<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>История заявок</title>
    <!-- Подключаем Bootstrap CSS -->
    <link href="../static/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <h1 class="mb-4">История заявок</h1>

        {% if requests %}
            <table class="table table-bordered table-striped">
                <thead class="thead-dark">
                    <tr>
                        <th>Услуга</th>
                        <th>Адрес</th>
                        <th>Дата и время</th>
                        <th>Тип оплаты</th>
                        <th>Статус</th>
                        <th>Действия</th>
                    </tr>
                </thead>
                <tbody>
                    {% for request in requests %}
                        <tr>
                            <td>{{ request.service }}</td>
                            <td>{{ request.address }}</td>
                            <td>{{ request.preferred_date_time }}</td>
                            <td>{{ request.get_payment_type_display }}</td>
                            <td>{{ request.get_status_display }}</td>
                            <td>
                                <form method="POST" class="form-inline">
                                    {% csrf_token %}
                                    <input type="hidden" name="request_id" value="{{ request.id }}">

                                    <!-- Изменение статуса -->
                                    <div class="form-group mr-2">
                                        <select name="new_status" class="form-control">
                                            <option value="new" {% if request.status == 'new' %}selected{% endif %}>Новая заявка</option>
                                            <option value="in_progress" {% if request.status == 'in_progress' %}selected{% endif %}>В работе</option>
                                            <option value="completed" {% if request.status == 'completed' %}selected{% endif %}>Выполнена</option>
                                            <option value="canceled" {% if request.status == 'canceled' %}selected{% endif %}>Отменена</option>
                                        </select>
                                    </div>

                                    <div class="form-group">
                                        <!-- Причина отмены (только для статуса "Отменена") -->
                                        <label for="cancellation_reason" class="sr-only">Причина отмены:</label>
                                        <textarea id="cancellation_reason" name="cancellation_reason" class="form-control" {% if request.status != 'canceled' %}disabled{% endif %}>{{ request.cancellation_reason }}</textarea>
                                    </div>

                                    <button type="submit" class="btn btn-primary ml-2">Изменить статус</button>
                                </form>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <p class="alert alert-info">Нет заявок.</p>
        {% endif %}
    </div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const statusSelect = document.querySelector('select[name="new_status"]');
        const cancellationReason = document.querySelector('#cancellation_reason');

        // Слушатель изменения статуса
        statusSelect.addEventListener('change', function () {
            if (this.value === 'canceled') {
                cancellationReason.removeAttribute('disabled'); // Активируем поле
            } else {
                cancellationReason.setAttribute('disabled', 'disabled'); // Отключаем поле
                cancellationReason.value = ''; // Очищаем поле
            }
        });
    });
</script>

</body>
</html>
